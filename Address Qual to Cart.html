<form class="address-form" id="addressForm">
    <div class="form-group"> <label for="addressInput" id="addressLabel">Address</label>
        <div class="address-input-container"> <input type="text" id="addressInput" class="address-input" placeholder="Start typing your address..." autocomplete="off" aria-describedby="addressHint addressError" aria-required="true" aria-invalid="false" aria-owns="suggestions" aria-autocomplete="list">
            <div class="spinner" id="loadingSpinner" aria-hidden="true"></div> <span class="input-icon" id="addressIcon" aria-hidden="true"></span>
            <div id="addressError" class="error-message">Please enter a valid address</div>
            <div id="addressHint" class="sr-only">As you type, address suggestions will appear below</div>
        </div>
        <div id="suggestions" class="suggestions-container" role="listbox" aria-label="Address suggestions"></div>
    </div> <button type="submit" class="btn" id="submitBtn" disabled>Check Availability</button>
</form>


<style>
    :root {
    --primary-color: #0066cc;
    --error-color: #d32f2f;
    --success-color: #388e3c;
    --text-color: #333;
    --border-color: #ccc;
    --focus-shadow: 0 0 0 3px rgba(0, 102, 204, 0.25);
}

* {
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

body {
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
    color: var(--text-color);
}

.address-form {
    max-width: 500px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.form-group {
    margin-bottom: 20px;
    position: relative;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.address-input-container {
    position: relative;
}

.address-input {
    width: 100%;
    padding: 12px 40px 12px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 16px;
    transition: all 0.2s ease;
}

.address-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: var(--focus-shadow);
}

.address-input.error {
    border-color: var(--error-color);
}

.address-input.valid {
    border-color: var(--success-color);
}

.input-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--border-color);
}

.input-icon.error {
    color: var(--error-color);
}

.input-icon.valid {
    color: var(--success-color);
}

.error-message {
    color: var(--error-color);
    font-size: 14px;
    margin-top: 5px;
    display: none;
}

.error-message.visible {
    display: block;
}

.suggestions-container {
    position: absolute;
    width: 100%;
    background: white;
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none;
}

.suggestion-item {
    padding: 10px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover,
.suggestion-item.highlighted {
    background-color: #f0f7ff;
}

.suggestion-item:not(:last-child) {
    border-bottom: 1px solid #eee;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

.btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%;
    margin-top: 10px;
}

.btn:hover {
    background-color: #0055b3;
}

.btn:focus {
    outline: none;
    box-shadow: var(--focus-shadow);
}

.btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .address-form {
        padding: 15px;
    }
}

/* High contrast mode support */
@media (forced-colors: active) {
    .address-input:focus {
        outline: 2px solid CanvasText;
    }

    .btn {
        border: 1px solid CanvasText;
    }
}

/* Loading indicator */
.spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
}

@keyframes spin {
    to {
        transform: translateY(-50%) rotate(360deg);
    }
}

.loading .spinner {
    display: block;
}

.loading .input-icon {
    display: none;
}

/* Custom map-marker-alt icon styles */
.input-icon {
    display: inline-block;
    width: 1em;
    height: 1em;
    font-size: 16px;
    line-height: 1;
    text-align: center;
}

.input-icon::before {
    content: '';
    display: inline-block;
    width: 0.75em;
    height: 1em;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='currentColor' d='M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}

.input-icon.error::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='%23d32f2f' d='M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z'%3E%3C/path%3E%3C/svg%3E");
}

.input-icon.valid::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='%23388e3c' d='M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z'%3E%3C/path%3E%3C/svg%3E");
}
</style>

<script>// Dynamically inject Radar.js script
(function () {
    var radarScript = document.createElement('script');
    radarScript.src = 'https://js.radar.com/v4/radar.min.js';
    radarScript.async = true;
    radarScript.onload = function () {
        // Initialize Radar once the script is loaded
        if (typeof Radar !== 'undefined') {
            console.log('Radar.js loaded successfully');
        }
    };
    radarScript.onerror = function () {
        console.error('Failed to load Radar.js');
    };
    document.head.appendChild(radarScript);
})();

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const addressInput = document.getElementById('addressInput');
    const addressForm = document.getElementById('addressForm');
    const suggestionsContainer = document.getElementById('suggestions');
    const addressIcon = document.getElementById('addressIcon');
    const errorMessage = document.getElementById('addressError');
    const submitBtn = document.getElementById('submitBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // State variables
    let debounceTimer;
    let selectedSuggestionIndex = -1;
    let suggestions = [];
    let addressValid = false;

    // Initialize Radar with publishable key
    const RADAR_PUBLISHABLE_KEY = 'prj_live_pk_d3a1113fc5c543c5fcd05f707d094fa5471b359d';

    // Initialize the component
    function init() {
        // Initialize Radar
        Radar.initialize(RADAR_PUBLISHABLE_KEY);

        // Event listeners
        addressInput.addEventListener('input', handleInput);
        addressInput.addEventListener('keydown', handleKeyDown);
        addressInput.addEventListener('focus', () => {
            if (addressInput.value.length > 0) {
                fetchSuggestions(addressInput.value);
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!addressInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });

        // Form submission
        addressForm.addEventListener('submit', handleSubmit);
    }

    // Handle input in the address field
    function handleInput(e) {
        const value = e.target.value.trim();

        // Clear previous timer
        clearTimeout(debounceTimer);

        // Reset validation state
        resetValidation();

        if (value.length < 3) {
            hideSuggestions();
            submitBtn.disabled = true;
            return;
        }

        // Set loading state
        addressInput.parentElement.classList.add('loading');

        // Debounce API calls
        debounceTimer = setTimeout(() => {
            fetchSuggestions(value);
        }, 300);
    }

    // Fetch address suggestions using Radar API
    function fetchSuggestions(query) {
        if (query.length < 3) return;

        Radar.autocomplete({
            query: query,
            limit: 5,
            layers: ['address'],
            country: 'US' // Can be removed or changed based on requirements
        }).then((result) => {
            // Process the results
            if (result.addresses && result.addresses.length > 0) {
                suggestions = result.addresses.map(address => {
                    return {
                        text: address.formattedAddress || address.addressText || '',
                        placeId: address.placeId || '',
                        details: {
                            street: address.addressLabel || (address.number ? address.number + ' ' + address.street : address.street) || '',
                            city: address.city || '',
                            state: address.state || '',
                            zip: address.postalCode || '',
                            country: address.country || ''
                        }
                    };
                });
            } else {
                suggestions = [];
            }

            // Remove loading state
            addressInput.parentElement.classList.remove('loading');

            // Display suggestions
            displaySuggestions(suggestions);

            // Update ARIA attributes
            addressInput.setAttribute('aria-expanded', suggestions.length > 0 ? 'true' : 'false');
        }).catch((err) => {
            console.error('Error fetching address suggestions:', err);
            addressInput.parentElement.classList.remove('loading');
            suggestions = [];
            hideSuggestions();
        });
    }

    // Display suggestions in the dropdown
    function displaySuggestions(items) {
        // Clear previous suggestions
        suggestionsContainer.innerHTML = '';

        if (items.length === 0) {
            hideSuggestions();
            return;
        }

        // Create suggestion elements
        items.forEach((item, index) => {
            const suggestionEl = document.createElement('div');
            suggestionEl.className = 'suggestion-item';
            suggestionEl.textContent = item.text;
            suggestionEl.setAttribute('role', 'option');
            suggestionEl.setAttribute('id', `suggestion-${index}`);
            suggestionEl.setAttribute('aria-selected', 'false');

            suggestionEl.addEventListener('click', () => {
                selectSuggestion(index);
            });

            suggestionsContainer.appendChild(suggestionEl);
        });

        // Show suggestions container
        suggestionsContainer.style.display = 'block';

        // Reset selected index
        selectedSuggestionIndex = -1;
    }

    // Hide suggestions dropdown
    function hideSuggestions() {
        suggestionsContainer.style.display = 'none';
        addressInput.setAttribute('aria-expanded', 'false');
        selectedSuggestionIndex = -1;
    }

    // Handle keyboard navigation
    function handleKeyDown(e) {
        // If suggestions are not displayed, return
        if (suggestionsContainer.style.display !== 'block') return;

        const suggestionItems = suggestionsContainer.querySelectorAll('.suggestion-item');

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                updateHighlightedSuggestion(suggestionItems);
                break;

            case 'ArrowUp':
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateHighlightedSuggestion(suggestionItems);
                break;

            case 'Enter':
                if (selectedSuggestionIndex >= 0) {
                    e.preventDefault();
                    selectSuggestion(selectedSuggestionIndex);
                }
                break;

            case 'Escape':
                e.preventDefault();
                hideSuggestions();
                break;
        }
    }

    // Update the highlighted suggestion
    function updateHighlightedSuggestion(items) {
        // Remove highlight from all items
        items.forEach(item => {
            item.classList.remove('highlighted');
            item.setAttribute('aria-selected', 'false');
        });

        // Add highlight to selected item
        if (selectedSuggestionIndex >= 0) {
            items[selectedSuggestionIndex].classList.add('highlighted');
            items[selectedSuggestionIndex].setAttribute('aria-selected', 'true');

            // Ensure the highlighted item is visible
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });

            // Announce to screen readers
            addressInput.setAttribute('aria-activedescendant', `suggestion-${selectedSuggestionIndex}`);
        } else {
            addressInput.removeAttribute('aria-activedescendant');
        }
    }

    // Select a suggestion
    function selectSuggestion(index) {
        const selectedAddress = suggestions[index];

        // Update input value
        addressInput.value = selectedAddress.text;

        // Hide suggestions
        hideSuggestions();

        // Validate the address
        validateAddress(selectedAddress);

        // Enable submit button
        submitBtn.disabled = false;

        // Focus on submit button for better UX
        submitBtn.focus();
    }

    // Validate the address using Radar API
    function validateAddress(address) {
        // Check if address is valid
        if (!address) {
            showError();
            return;
        }

        addressValid = true;
        addressInput.classList.add('valid');
        addressIcon.classList.remove('error');
        addressIcon.classList.add('valid');

        // Update ARIA attributes
        addressInput.setAttribute('aria-invalid', 'false');

        // Store the selected address for submission
        addressInput.dataset.selectedAddress = JSON.stringify(address.details);
        if (address.placeId) {
            addressInput.dataset.placeId = address.placeId;
        }
    }

    // Show error state
    function showError() {
        addressValid = false;
        addressInput.classList.add('error');
        addressIcon.classList.add('error');
        errorMessage.classList.add('visible');

        // Update ARIA attributes
        addressInput.setAttribute('aria-invalid', 'true');
    }

    // Reset validation state
    function resetValidation() {
        addressValid = false;
        addressInput.classList.remove('valid', 'error');
        addressIcon.classList.remove('valid', 'error');
        errorMessage.classList.remove('visible');

        // Update ARIA attributes
        addressInput.setAttribute('aria-invalid', 'false');

        // Remove stored address
        delete addressInput.dataset.selectedAddress;
        delete addressInput.dataset.placeId;
    }

    // Handle form submission
    function handleSubmit(e) {
        e.preventDefault();

        if (!addressValid) {
            // Show error message
            showError();
            // Focus back on input
            addressInput.focus();
            return;
        }

        // Get selected address details
        let addressDetails;
        try {
            addressDetails = JSON.parse(addressInput.dataset.selectedAddress);
        } catch (err) {
            console.error('Error parsing address details:', err);
            showError();
            return;
        }

        // Format address for URL parameter in the format expected by CartAutomation.js
        // Format: street, city, state zip country
        const formattedAddress = formatAddressForUrl(addressDetails);

        // Create the URL with the address parameter
        const cartUrl = `/cart?address=${encodeURIComponent(formattedAddress)}`;

        // Redirect to the cart URL
        window.location.href = cartUrl;
    }

    // Format address for URL parameter
    function formatAddressForUrl(details) {
        // Format: street, city, state zip country
        const street = details.street || '';
        const city = details.city || '';
        const state = details.state || '';
        const zip = details.zip || '';
        const country = details.country || '';

        return `${street}, ${city}, ${state} ${zip} ${country}`;
    }

    // Initialize the component
    init();
});
</script>